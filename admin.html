<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>みまもり 管理画面</title>
<style>
  body{font-family:system-ui, sans-serif; background:#f5f6fa; padding:22px; margin:0;}
  .wrap{max-width:920px; margin:0 auto;}
  .card{background:#fff; padding:18px; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,0.08); margin-bottom:14px;}
  h1{margin:0 0 12px; font-size:22px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  input{padding:10px; border:2px solid #ddd; border-radius:10px; font-size:14px; flex:1; min-width:220px;}
  button{padding:10px 12px; border:none; border-radius:10px; cursor:pointer; color:#fff; background:#667eea;}
  button.gray{background:#6c757d;}
  button.red{background:#dc3545;}
  button.green{background:#28a745;}
  button.purple{background:#764ba2;}
  pre{background:#f1f3f5; padding:12px; border-radius:12px; white-space:pre-wrap; font-size:12px;}
  table{width:100%; border-collapse:collapse; font-size:13px;}
  th,td{border-bottom:1px solid #eee; padding:10px; text-align:left; vertical-align:top;}
  th{color:#555;}
  .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef; color:#334;}
  .stop{background:#fee; color:#811;}
  .ok{background:#e8f5e9; color:#1b5e20; padding:10px; border-radius:10px;}
  .ng{background:#ffebee; color:#b71c1c; padding:10px; border-radius:10px;}
  .small{font-size:12px; color:#666; line-height:1.6;}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>みまもり 管理画面</h1>

    <div class="row">
      <input id="adminKey" type="password" placeholder="ADMIN KEY（端末内に保存されます）">
      <button class="gray" onclick="saveKey()">保存</button>
      <button class="gray" onclick="clearKey()">消去</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="familyName" placeholder="家族名（例：D家）">
      <button class="green" onclick="createCustomer()">家族を追加</button>
      <button class="purple" onclick="loadCustomers()">一覧更新</button>
    </div>

    <div id="status" class="small" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="small">
      家族一覧（URLコピー / QR表示 / 停止 / 再開 / キー再発行）
    </div>
    <div id="tableArea" style="margin-top:10px;">読み込み前</div>
  </div>

  <div class="card">
    <div class="small">結果ログ</div>
    <pre id="log"></pre>
  </div>

</div>

<script>
  const WORKER = "https://yellow-bird-8e16.kamuibibi4144.workers.dev";
  const BASE = "https://kamuibibi.github.io/mimamori-web/?key=";

  const adminKeyEl = document.getElementById("adminKey");
  const familyNameEl = document.getElementById("familyName");
  const statusEl = document.getElementById("status");
  const logEl = document.getElementById("log");
  const tableArea = document.getElementById("tableArea");

  function getKey(){ return localStorage.getItem("mimamori_admin_key") || ""; }
  function setKey(v){ localStorage.setItem("mimamori_admin_key", v); }

  adminKeyEl.value = getKey();

  function setStatus(msg, ok=true){
    statusEl.className = ok ? "ok" : "ng";
    statusEl.textContent = msg;
  }

  function log(obj){
    logEl.textContent = JSON.stringify(obj, null, 2);
  }

  function saveKey(){
    setKey(adminKeyEl.value.trim());
    setStatus("ADMIN KEY を端末内に保存しました。", true);
  }

  function clearKey(){
    localStorage.removeItem("mimamori_admin_key");
    adminKeyEl.value = "";
    setStatus("ADMIN KEY を消去しました。", true);
  }

  function headers(){
    const k = getKey();
    if(!k) throw new Error("ADMIN KEY が空です");
    return {
      "Content-Type":"application/json",
      "X-Admin-Key": k
    };
  }

  async function createCustomer(){
    try{
      const name = familyNameEl.value.trim();
      if(!name) return setStatus("家族名を入れてください。", false);

      setStatus("作成中...", true);
      const r = await fetch(WORKER + "/admin/create-customer", {
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ family_name: name })
      });
      const d = await r.json();
      log(d);

      if(!r.ok) return setStatus(d.error || "作成失敗", false);

      setStatus("作成しました。下の一覧を更新します。", true);
      familyNameEl.value = "";
      await loadCustomers();
    }catch(e){
      setStatus(e.message, false);
    }
  }

  async function loadCustomers(){
    try{
      setStatus("一覧取得中...", true);
      const r = await fetch(WORKER + "/admin/list-customers", {
        method:"GET",
        headers: headers()
      });
      const d = await r.json();
      log(d);

      if(!r.ok) return setStatus(d.error || "取得失敗", false);

      const rows = d.customers || [];
      tableArea.innerHTML = renderTable(rows);
      setStatus(`取得OK：${rows.length}件`, true);
    }catch(e){
      setStatus(e.message, false);
    }
  }

  function esc(s){
    return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function copyText(text){
    navigator.clipboard.writeText(text);
    setStatus("コピーしました。", true);
  }

  function openQR(url){
    // 外部サービスでQRを表示（簡単優先）
    const qr = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(url);
    window.open(qr, "_blank");
  }

  async function rotateKey(customer_id){
    if(!confirm("キーを再発行します。古いURLは使えなくなります。よろしいですか？")) return;
    try{
      const r = await fetch(WORKER + "/admin/rotate-key", {
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ customer_id })
      });
      const d = await r.json();
      log(d);
      if(!r.ok) return setStatus(d.error || "失敗", false);
      setStatus("再発行しました。一覧を更新します。", true);
      await loadCustomers();
    }catch(e){
      setStatus(e.message, false);
    }
  }

  async function setCustomerStatus(customer_id, status){
    try{
      const r = await fetch(WORKER + "/admin/set-status", {
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ customer_id, status })
      });
      const d = await r.json();
      log(d);
      if(!r.ok) return setStatus(d.error || "失敗", false);
      setStatus("更新しました。", true);
      await loadCustomers();
    }catch(e){
      setStatus(e.message, false);
    }
  }

  function renderTable(rows){
    if(rows.length === 0) return "データなし";
    return `
      <table>
        <thead>
          <tr>
            <th>家族名</th>
            <th>状態</th>
            <th>customer_id</th>
            <th>URL / 操作</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>{
            const fam = esc(r.family_name || "");
            const st = r.status || "active";
            const tag = st === "active" ? `<span class="tag">active</span>` : `<span class="tag stop">stop</span>`;
            const url = BASE + encodeURIComponent(r.customer_key);
            return `
              <tr>
                <td>${fam}</td>
                <td>${tag}</td>
                <td><code>${esc(r.customer_id)}</code></td>
                <td>
                  <div style="margin-bottom:6px;"><code>${esc(url)}</code></div>
                  <div class="row">
                    <button class="gray" onclick='copyText("${esc(url)}")'>URLコピー</button>
                    <button class="gray" onclick='openQR("${esc(url)}")'>QR表示</button>
                    <button class="purple" onclick='rotateKey("${esc(r.customer_id)}")'>再発行</button>
                    ${st === "active"
                      ? `<button class="red" onclick='setCustomerStatus("${esc(r.customer_id)}","stop")'>停止</button>`
                      : `<button class="green" onclick='setCustomerStatus("${esc(r.customer_id)}","active")'>再開</button>`
                    }
                  </div>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  }

  // 初回表示
  if(getKey()){
    setStatus("ADMIN KEY が保存されています。必要なら一覧更新してください。", true);
  }else{
    setStatus("ADMIN KEY を入れて保存してください。", false);
  }
</script>
</body>
</html>
