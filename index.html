<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ  ã¿ã¾ã‚‚ã‚Šã‚¢ãƒ—ãƒª</title>
  <style>
    body{
      font-family:system-ui, sans-serif;
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);
      padding:20px;
      transition: background 0.3s ease;
    }
    body.custom-bg{
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
    }

    .box{
      background:rgba(255,255,255,0.95);
      width:100%;
      max-width:520px;
      border-radius:18px;
      padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,0.15);
      position:relative;
    }

    /* å³ä¸Šã®è¨­å®šãƒœã‚¿ãƒ³ï¼ˆèƒŒæ™¯å¤‰æ›´ï¼‰ */
    .settings-btn{
      position:absolute;
      top:14px;
      right:14px;
      width:44px;
      height:44px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background: rgba(102,126,234,0.12);
      color:#334;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform 0.15s ease;
    }
    .settings-btn:hover{ transform: scale(1.05); }

    h1{margin:0 0 12px; color:#4b5bdc; font-size:26px;}
    .meta{font-size:14px; color:#555; line-height:1.6; margin-bottom:14px; white-space:pre-line;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;}
    input{flex:1; min-width:220px; padding:12px; font-size:16px; border:2px solid #ddd; border-radius:10px;}
    button{
      width:100%;
      padding:16px;
      font-size:20px;
      border:none;
      border-radius:999px;
      color:#fff;
      cursor:pointer;
      background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);
      box-shadow:0 6px 18px rgba(102,126,234,0.35);
    }
    button:disabled{opacity:0.5; cursor:not-allowed; box-shadow:none;}
    .smallBtn{width:auto; padding:10px 14px; font-size:14px; border-radius:12px;}
    #msg{margin-top:12px; padding:12px; border-radius:12px; font-size:16px; line-height:1.6; white-space:pre-line;}
    .ok{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
    .ng{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
    .note{font-size:12px; color:#666; margin-top:10px; line-height:1.6;}
    .hr{height:1px; background:#eee; margin:14px 0;}

    /* ===== èƒŒæ™¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.45);
      z-index:9999;
    }
    .modal-content{
      position:relative;
      max-width:560px;
      width:92%;
      margin: 8vh auto;
      background:#fff;
      border-radius:14px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }
    .modal-close{
      position:absolute;
      top:10px;
      right:10px;
      width:36px;
      height:36px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:#f1f1f1;
      color:#333;
      font-size:18px;
    }
    .modal h2{ margin:0 0 14px; color:#4b5bdc; }
    .bg-row{ margin:14px 0; }
    .bg-row label{ display:block; margin-bottom:8px; font-weight:700; color:#333; }
    .bg-row input[type="text"], .bg-row input[type="file"]{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:10px;
      font-size:14px;
      box-sizing:border-box;
    }
    .subbtn{
      margin-top:10px;
      width:100%;
      padding:10px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      color:#fff;
      background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);
      box-shadow:0 4px 12px rgba(102,126,234,0.25);
      font-size:14px;
    }
    .preset-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .preset{
      height:64px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    }
    .p1{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .p2{ background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .p3{ background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .p4{ background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .p5{ background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .p6{ background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }

    .danger{
      margin-top:12px;
      width:100%;
      padding:10px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      color:#fff;
      background:linear-gradient(135deg,#f093fb 0%, #f5576c 100%);
      box-shadow:0 4px 12px rgba(240,147,251,0.2);
      font-size:14px;
    }

    @media (max-width: 520px){
      .preset-grid{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="box">
    <!-- åœæ­¢ä¸­ã§ã‚‚èƒŒæ™¯å¤‰æ›´ã¯ã§ãã‚‹ -->
    <button class="settings-btn" type="button" onclick="openBgModal()">âš™ï¸</button>

    <h1>ğŸ  ã¿ã¾ã‚‚ã‚Šã‚¢ãƒ—ãƒª</h1>

    <div class="meta" id="info">
      èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div class="row">
      <input id="sender" placeholder="é€ä¿¡è€…åï¼ˆä¾‹ï¼šãŠã°ã‚ã¡ã‚ƒã‚“ï¼‰" />
      <button class="smallBtn" onclick="saveSender()">ä¿å­˜</button>
    </div>

    <button id="btn" onclick="send()">ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹</button>

    <div id="msg"></div>

    <div class="hr"></div>

    <div class="note">
      é€£æ‰“é˜²æ­¢ï¼šé€ä¿¡å¾Œã—ã°ã‚‰ãæŠ¼ã›ã¾ã›ã‚“ã€‚<br/>
      é€ä¿¡ã§ããŸã‚‰çŸ­ãæŒ¯å‹•ã—ã¾ã™ï¼ˆç«¯æœ«ã«ã‚ˆã£ã¦æŒ¯å‹•ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚<br/>
      èƒŒæ™¯ã¯ã€Œå®¶æ—ã”ã¨ï¼ˆURLã®keyã”ã¨ï¼‰ã€ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆåŒã˜ç«¯æœ«å†…ï¼‰ã€‚
    </div>
  </div>

  <!-- èƒŒæ™¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåœæ­¢ä¸­ã§ã‚‚ä½¿ãˆã‚‹ï¼‰ -->
  <div id="bgModal" class="modal" onclick="if(event.target.id==='bgModal') closeBgModal()">
    <div class="modal-content">
      <button class="modal-close" type="button" onclick="closeBgModal()">Ã—</button>
      <h2>ğŸ–¼ï¸ èƒŒæ™¯ã‚’å¤‰æ›´</h2>

      <div class="bg-row">
        <label>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="bgFile" accept="image/*" />
      </div>

      <div class="bg-row">
        <label>ç”»åƒURL</label>
        <input type="text" id="bgUrl" placeholder="https://example.com/bg.jpg" />
        <button type="button" class="subbtn" onclick="applyBgUrl()">é©ç”¨</button>
      </div>

      <div class="bg-row">
        <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
        <div class="preset-grid">
          <button type="button" class="preset p1" onclick="applyPreset(1)"></button>
          <button type="button" class="preset p2" onclick="applyPreset(2)"></button>
          <button type="button" class="preset p3" onclick="applyPreset(3)"></button>
          <button type="button" class="preset p4" onclick="applyPreset(4)"></button>
          <button type="button" class="preset p5" onclick="applyPreset(5)"></button>
          <button type="button" class="preset p6" onclick="applyPreset(6)"></button>
        </div>
      </div>

      <button type="button" class="danger" onclick="resetBg()">ğŸ”„ èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

<script>
  const WORKER_URL = "https://yellow-bird-8e16.kamuibibi4144.workers.dev";
  const DEFAULT_MESSAGE = "ä»Šã€å°‘ã—ä¸å®‰ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚";

  const qs = new URLSearchParams(location.search);
  const customerKey = qs.get("key") || "";

  const senderInput = document.getElementById("sender");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");
  const info = document.getElementById("info");

  // ãƒ•ãƒ­ãƒ³ãƒˆå´ã®é€£æ‰“é˜²æ­¢ï¼ˆç§’ï¼‰
  const FRONT_COOLDOWN = 30;

  function show(text, ok=true){
    msg.className = ok ? "ok" : "ng";
    msg.textContent = text;
  }

  function vibrateOK(){
    try{
      if (navigator.vibrate) navigator.vibrate([80, 40, 80]);
    }catch(e){}
  }

  function loadSender(){
    const saved = localStorage.getItem("mimamori_sender") || "";
    senderInput.value = saved;
  }
  loadSender();

  function saveSender(){
    localStorage.setItem("mimamori_sender", senderInput.value.trim().slice(0,20));
    show("é€ä¿¡è€…åã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", true);
    setTimeout(()=>{ msg.textContent=""; msg.className=""; }, 1200);
  }

  function setButtonCooldown(seconds){
    btn.disabled = true;
    const base = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
    let left = seconds;
    btn.textContent = `${base}ï¼ˆ${left}ç§’ï¼‰`;
    const t = setInterval(()=>{
      left--;
      if(left <= 0){
        clearInterval(t);
        btn.disabled = false;
        btn.textContent = base;
        return;
      }
      btn.textContent = `${base}ï¼ˆ${left}ç§’ï¼‰`;
    }, 1000);
  }

  function getLastLocalSent(){
    const v = localStorage.getItem("mimamori_last_sent") || "";
    return v ? new Date(v) : null;
  }

  function setLastLocalSent(){
    localStorage.setItem("mimamori_last_sent", new Date().toISOString());
  }

  async function refreshInfo(){
    if(!customerKey){
      info.textContent = "URLã® key ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã‹ã‚‰æ¸¡ã•ã‚ŒãŸURLã§é–‹ã„ã¦ãã ã•ã„ã€‚";
      btn.disabled = true;
      return;
    }

    try{
      const r = await fetch(`${WORKER_URL}/customer-info`, {
        headers: { "X-Customer-Key": customerKey }
      });
      const d = await r.json();

      if(!r.ok){
        info.textContent = `ã“ã®URLã¯ä½¿ãˆã¾ã›ã‚“ï¼š${d.error || "error"}`;
        btn.disabled = true;
        return;
      }

      const fam = d.customer.family_name ? d.customer.family_name : "ï¼ˆå®¶æ—åæœªè¨­å®šï¼‰";
      const status = d.customer.status || "active";
      const last = d.customer.last_sent_at ? new Date(d.customer.last_sent_at).toLocaleString("ja-JP") : "ãªã—";
      const sc = d.server?.cooldown_seconds ?? "?";

      if(status !== "active"){
        // åœæ­¢ä¸­ï¼šé€šçŸ¥ã¯ä¸å¯ã€‚ãŸã ã—èƒŒæ™¯è¨­å®šã¯å¯èƒ½ã€‚
        info.textContent = `å®¶æ—ï¼š${fam}\nã“ã®URLã¯ä½¿ãˆã¾ã›ã‚“ï¼šThis customer is stopped`;
        btn.disabled = true;
        btn.textContent = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
        return;
      }

      info.textContent = `å®¶æ—ï¼š${fam}\næœ€çµ‚é€ä¿¡ï¼š${last}\nã‚µãƒ¼ãƒé€£æ‰“é˜²æ­¢ï¼š${sc}ç§’`;

      // ãƒ­ãƒ¼ã‚«ãƒ«é€£æ‰“é˜²æ­¢ï¼ˆæœ€å¾Œã«æŠ¼ã—ã¦ã™ããªã‚‰æ­¢ã‚ã‚‹ï¼‰
      const lastLocal = getLastLocalSent();
      if(lastLocal){
        const diff = (Date.now() - lastLocal.getTime()) / 1000;
        if(diff < FRONT_COOLDOWN){
          setButtonCooldown(Math.ceil(FRONT_COOLDOWN - diff));
        }
      }
    }catch(e){
      info.textContent = "æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    }
  }

  async function send(){
    if(!customerKey){
      show("URLã® key ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", false);
      return;
    }

    // ãƒ•ãƒ­ãƒ³ãƒˆå´é€£æ‰“é˜²æ­¢
    const lastLocal = getLastLocalSent();
    if(lastLocal){
      const diff = (Date.now() - lastLocal.getTime()) / 1000;
      if(diff < FRONT_COOLDOWN){
        show(`é€£æ‰“é˜²æ­¢ä¸­ã§ã™ã€‚ã‚ã¨ ${Math.ceil(FRONT_COOLDOWN - diff)} ç§’å¾…ã£ã¦ãã ã•ã„ã€‚`, false);
        return;
      }
    }

    btn.disabled = true;
    btn.textContent = "é€ä¿¡ä¸­...";
    msg.className = "";
    msg.textContent = "é€ä¿¡ä¸­...";

    try{
      const senderName = (senderInput.value || "").trim().slice(0,20);

      const r = await fetch(`${WORKER_URL}/notify`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Customer-Key": customerKey
        },
        body: JSON.stringify({
          message: DEFAULT_MESSAGE,
          sender_name: senderName
        })
      });

      const d = await r.json();

      if(r.ok){
        setLastLocalSent();
        vibrateOK();
        show(`é€ä¿¡ã—ã¾ã—ãŸã€‚\næˆåŠŸ:${d.successCount} / å¤±æ•—:${d.failedCount}`, true);

        // ãƒœã‚¿ãƒ³é€£æ‰“é˜²æ­¢ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆï¼‰
        setButtonCooldown(FRONT_COOLDOWN);

        // ç”»é¢ã®æƒ…å ±ã‚‚æ›´æ–°ï¼ˆæœ€çµ‚é€ä¿¡æ™‚åˆ»ã‚’æ›´æ–°ï¼‰
        setTimeout(refreshInfo, 800);
      }else{
        // ã‚µãƒ¼ãƒå´ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãªã©
        const err = d.error || "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
        show(err, false);

        // 429ã®ã¨ãã¯ç§’æ•°ã«åˆã‚ã›ã¦æ­¢ã‚ã‚‹
        if(r.status === 429 && d.cooldown_seconds){
          setButtonCooldown( Math.min(d.cooldown_seconds, 60) );
        }else{
          btn.disabled = false;
          btn.textContent = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
        }
      }
    }catch(e){
      show(`é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e.message}`, false);
      btn.disabled = false;
      btn.textContent = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
    }
  }

  // ===== èƒŒæ™¯è¨­å®šï¼šå®¶æ—ã”ã¨ï¼ˆkeyã”ã¨ï¼‰ã«ä¿å­˜ =====
  function getBgStorageKey() {
    if (!customerKey) return "mimamori_bg_v1:global";
    return `mimamori_bg_v1:${customerKey}`;
  }

  function openBgModal() {
    document.getElementById("bgModal").style.display = "block";
  }
  function closeBgModal() {
    document.getElementById("bgModal").style.display = "none";
  }

  function applyBg(styleObj) {
    if (styleObj.mode === "image") {
      document.body.style.background = "none";
      document.body.style.backgroundImage = `url('${styleObj.value}')`;
      document.body.classList.add("custom-bg");
    } else {
      document.body.style.backgroundImage = "none";
      document.body.style.background = styleObj.value;
      document.body.classList.remove("custom-bg");
    }
    localStorage.setItem(getBgStorageKey(), JSON.stringify(styleObj));
  }

  function applyPreset(n) {
    const presets = {
      1: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
      2: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
      3: "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
      4: "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
      5: "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
      6: "linear-gradient(135deg, #30cfd0 0%, #330867 100%)"
    };
    applyBg({ mode: "gradient", value: presets[n] });
    closeBgModal();
  }

  function applyBgUrl() {
    const url = (document.getElementById("bgUrl").value || "").trim();
    if (!url) return;
    applyBg({ mode: "image", value: url });
    closeBgModal();
  }

  function resetBg() {
    localStorage.removeItem(getBgStorageKey());
    document.body.style.backgroundImage = "none";
    document.body.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
    document.body.classList.remove("custom-bg");
    closeBgModal();
  }

  document.addEventListener("DOMContentLoaded", () => {
    // èƒŒæ™¯ã‚’å¾©å…ƒï¼ˆå®¶æ—ã”ã¨ï¼‰
    const saved = localStorage.getItem(getBgStorageKey());
    if (saved) {
      try { applyBg(JSON.parse(saved)); } catch(e) {}
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const file = document.getElementById("bgFile");
    if (file) {
      file.addEventListener("change", (ev) => {
        const f = ev.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          applyBg({ mode: "image", value: e.target.result });
          closeBgModal();
        };
        reader.readAsDataURL(f);
      });
    }
  });

  refreshInfo();
</script>
</body>
</html>
