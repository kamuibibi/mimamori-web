<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ  ã¿ã¾ã‚‚ã‚Šã‚¢ãƒ—ãƒª v2.4</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      transition: background 0.3s ease;
    }
    body.custom-bg {
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 500px;
      width: 100%;
      position: relative;
    }
    .settings-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid #667eea;
      font-size: 24px;
      cursor: pointer;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 10;
    }
    .settings-btn:hover { background: #667eea; transform: scale(1.1); }
    h1 { color: #667eea; margin-bottom: 20px; font-size: 32px; text-align: center; }

    .key-badge{
      margin: 0 auto 18px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      background: #f1f3ff;
      color: #3a46a5;
      text-align: left;
      line-height: 1.5;
      word-break: break-all;
      border: 1px solid #d7dcff;
    }
    .key-badge strong { display: inline-block; margin-right: 6px; }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 24px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      display: block;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
    button:active { transform: translateY(0); }

    #responseMessage { margin-top: 20px; padding: 15px; border-radius: 10px; font-size: 18px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 20px; }
    .close:hover { color: #000; }
    .modal h2 { color: #667eea; margin-bottom: 20px; }

    .settings-menu { display: flex; flex-direction: column; gap: 15px; }
    .settings-item {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      border: 2px solid transparent;
    }
    .settings-item:hover { border-color: #667eea; transform: translateX(5px); }
    .settings-item-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
    .settings-item-desc { font-size: 14px; color: #666; }

    .history-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: left;
      border-left: 4px solid #667eea;
    }
    .history-date { font-size: 14px; color: #666; margin-bottom: 5px; }
    .history-message { font-size: 16px; margin-bottom: 10px; white-space: pre-wrap; }
    .history-stats { font-size: 14px; color: #28a745; }

    .bg-presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
    .bg-preset { height: 80px; border-radius: 10px; cursor: pointer; border: 3px solid transparent; transition: all 0.3s; }
    .bg-preset:hover { border-color: #667eea; transform: scale(1.05); }
    .bg-preset-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .bg-preset-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .bg-preset-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .bg-preset-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .bg-preset-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .bg-preset-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }

    .bg-option { margin: 20px 0; text-align: left; }
    .bg-option label { display: block; margin-bottom: 10px; font-weight: bold; }
    .bg-option input[type="text"], .bg-option input[type="file"] {
      width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;
    }
    .bg-option button { margin-top: 10px; padding: 10px 20px; font-size: 16px; }

    .family-item { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: left; border-left: 4px solid #667eea; margin-bottom: 12px; }
    .family-nickname { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
    .family-userid { font-size: 12px; color: #666; margin-bottom: 5px; word-break: break-all; }
    .family-date { font-size: 12px; color: #999; margin-bottom: 10px; }
    .family-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .family-actions button { padding: 8px 15px; font-size: 14px; flex: 1; min-width: 100px; }
    .btn-edit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-toggle { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .btn-delete { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .family-item.inactive { opacity: 0.5; border-left-color: #ccc; }

    .invite-container { text-align: center; }
    .qr-code {
      max-width: 300px; width: 100%;
      margin: 20px auto;
      display: block;
      border: 2px solid #667eea;
      border-radius: 10px;
      padding: 10px;
      background: white;
    }
    .invite-instructions {
      text-align: left;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .invite-instructions h3 { color: #667eea; margin-bottom: 10px; }
    .invite-instructions ol { margin-left: 20px; }
    .invite-instructions li { margin-bottom: 10px; line-height: 1.6; }

    .status {
      position: fixed; top: 20px; right: 20px;
      background: #28a745; color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 2000;
      animation: slideInRight 0.3s;
    }
    @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .status.error { background: #dc3545; }

    @media (max-width: 600px) {
      .container { padding: 30px 20px; }
      h1 { font-size: 24px; }
      button { font-size: 20px; padding: 15px 30px; }
      .bg-presets { grid-template-columns: repeat(2, 1fr); }
      .qr-code { max-width: 250px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
    <h1>ğŸ  ã¿ã¾ã‚‚ã‚Šã‚¢ãƒ—ãƒª</h1>

    <div id="keyBadge" class="key-badge"></div>

    <button id="notifyButton" onclick="sendNotification()">ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹</button>
    <div id="responseMessage"></div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSettings()">&times;</span>
      <h2>âš™ï¸ è¨­å®š</h2>
      <div class="settings-menu">
        <div class="settings-item" onclick="showFamilyManagement()">
          <div class="settings-item-title">ğŸ‘¥ å®¶æ—ã®ç®¡ç†</div>
          <div class="settings-item-desc">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å®¶æ—ã®ç¢ºèªãƒ»ç·¨é›†</div>
        </div>
        <div class="settings-item" onclick="showInvite()">
          <div class="settings-item-title">â• å®¶æ—ã‚’æ‹›å¾…</div>
          <div class="settings-item-desc">ã“ã®ãƒšãƒ¼ã‚¸URLã®QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</div>
        </div>
        <div class="settings-item" onclick="showHistory()">
          <div class="settings-item-title">ğŸ“œ é€šçŸ¥å±¥æ­´ã‚’è¦‹ã‚‹</div>
          <div class="settings-item-desc">éå»ã®é€šçŸ¥è¨˜éŒ²ã‚’ç¢ºèª</div>
        </div>
        <div class="settings-item" onclick="showBackgroundSettings()">
          <div class="settings-item-title">ğŸ–¼ï¸ èƒŒæ™¯ã‚’å¤‰æ›´</div>
          <div class="settings-item-desc">ã‚¢ãƒ—ãƒªã®èƒŒæ™¯ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInvite()">&times;</span>
      <h2>â• å®¶æ—ã‚’æ‹›å¾…</h2>
      <div class="invite-container">
        <p>å®¶æ—ã«ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„ï¼ˆã“ã®ãƒšãƒ¼ã‚¸URLã§ã™ï¼‰ã€‚</p>
        <img id="inviteQr" alt="æ‹›å¾…QRã‚³ãƒ¼ãƒ‰" class="qr-code">
        <div class="key-badge" style="margin-top:10px;">
          <div><strong>ç™»éŒ²ã‚­ãƒ¼:</strong> <span id="inviteKeyText"></span></div>
          <div style="margin-top:6px;">é€šçŸ¥ã‚’å—ã‘å–ã‚ŠãŸã„äººã¯ã€LINEã§ã“ã®ãƒœãƒƒãƒˆã« <strong>ã€Œç™»éŒ² ã‚­ãƒ¼ã€</strong> ã‚’é€ã£ã¦ãã ã•ã„ã€‚</div>
        </div>

        <div class="invite-instructions">
          <h3>ğŸ“± æ‹›å¾…æ‰‹é †</h3>
          <ol>
            <li>å®¶æ—ã®ã‚¹ãƒãƒ›ã§LINEã‚¢ãƒ—ãƒªã‚’é–‹ã</li>
            <li>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
            <li>é€šçŸ¥ã‚’å—ã‘å–ã‚ŠãŸã„äººã¯ã€LINEã§ãƒœãƒƒãƒˆã«ã€Œç™»éŒ² ã“ã“ã«ã‚­ãƒ¼ã€ã‚’é€ã‚‹</li>
            <li>ä»¥å¾Œã€ã“ã®å®¶æ—ã‚­ãƒ¼ã®é€šçŸ¥ã ã‘ãŒå±Šãã¾ã™</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeHistory()">&times;</span>
      <h2>ğŸ“œ é€šçŸ¥å±¥æ­´</h2>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- èƒŒæ™¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="backgroundModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBackgroundSettings()">&times;</span>
      <h2>ğŸ–¼ï¸ èƒŒæ™¯ã‚’å¤‰æ›´</h2>

      <div class="bg-option">
        <label>ğŸ“± ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼š</label>
        <input type="file" id="bgFileInput" accept="image/*" onchange="handleFileSelect(event)">
      </div>

      <div class="bg-option">
        <label>ğŸ”— ç”»åƒURLã‚’å…¥åŠ›ï¼š</label>
        <input type="text" id="bgUrlInput" placeholder="https://example.com/image.jpg">
        <button onclick="applyCustomBackground()">é©ç”¨</button>
      </div>

      <div class="bg-option">
        <label>ğŸ¨ ãƒ—ãƒªã‚»ãƒƒãƒˆèƒŒæ™¯ï¼š</label>
        <div class="bg-presets">
          <div class="bg-preset bg-preset-1" onclick="applyPresetBackground(1)"></div>
          <div class="bg-preset bg-preset-2" onclick="applyPresetBackground(2)"></div>
          <div class="bg-preset bg-preset-3" onclick="applyPresetBackground(3)"></div>
          <div class="bg-preset bg-preset-4" onclick="applyPresetBackground(4)"></div>
          <div class="bg-preset bg-preset-5" onclick="applyPresetBackground(5)"></div>
          <div class="bg-preset bg-preset-6" onclick="applyPresetBackground(6)"></div>
        </div>
      </div>

      <button onclick="resetBackground()">ğŸ”„ èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- å®¶æ—ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="familyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeFamilyManagement()">&times;</span>
      <h2>ğŸ‘¥ å®¶æ—ã®ç®¡ç†</h2>
      <div id="familyList"></div>
    </div>
  </div>

  <script>
    const CONFIG = {
      WORKER_URL: 'https://yellow-bird-8e16.kamuibibi4144.workers.dev',
      MESSAGE: 'ã€ã¿ã¾ã‚‚ã‚Šé€šçŸ¥ã€‘\nä»Šã€å°‘ã—ä¸å®‰ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ğŸ ',
      get CUSTOMER_KEY() {
        const url = new URL(location.href);
        return (url.searchParams.get('key') || '').trim();
      },
      get PAGE_URL() {
        return location.href;
      }
    };

    function renderKeyBadge() {
      const el = document.getElementById('keyBadge');
      if (CONFIG.CUSTOMER_KEY) {
        el.innerHTML =
          `<div><strong>ç™»éŒ²ã‚­ãƒ¼:</strong> ${escapeHtml(CONFIG.CUSTOMER_KEY)}</div>` +
          `<div style="margin-top:6px;">é€šçŸ¥ã‚’å—ã‘å–ã‚ŠãŸã„äººã¯ã€LINEã§ <strong>ã€Œç™»éŒ² ${escapeHtml(CONFIG.CUSTOMER_KEY)}ã€</strong> ã‚’é€ã£ã¦ãã ã•ã„ã€‚</div>`;
      } else {
        el.innerHTML =
          `<div><strong>ç™»éŒ²ã‚­ãƒ¼:</strong> ãªã—</div>` +
          `<div style="margin-top:6px;">URLã« <strong>?key=ã‚ãªãŸã®ã‚­ãƒ¼</strong> ã‚’ä»˜ã‘ã¦é–‹ã„ã¦ãã ã•ã„ã€‚</div>`;
      }
    }

    async function sendNotification() {
      const responseElement = document.getElementById('responseMessage');

      if (!CONFIG.CUSTOMER_KEY) {
        responseElement.innerHTML = 'âŒ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ç™»éŒ²ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆURLã« ?key=... ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼‰';
        responseElement.className = 'error';
        return;
      }

      responseElement.innerHTML = 'é€ä¿¡ä¸­...';
      responseElement.className = '';

      try {
        const response = await fetch(`${CONFIG.WORKER_URL}/notify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Customer-Key': CONFIG.CUSTOMER_KEY
          },
          body: JSON.stringify({ message: CONFIG.MESSAGE })
        });

        const result = await response.json();

        if (response.ok) {
          responseElement.innerHTML = `âœ… é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼<br>æˆåŠŸ: ${result.successCount}äºº / å¤±æ•—: ${result.failedCount}äºº`;
          responseElement.className = 'success';
        } else {
          responseElement.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${escapeHtml(result.error || 'unknown error')}`;
          responseElement.className = 'error';
        }
      } catch (error) {
        responseElement.innerHTML = `âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(error.message)}`;
        responseElement.className = 'error';
      }
    }

    function showSettings() { document.getElementById('settingsModal').style.display = 'block'; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }

    function showInvite() {
      closeSettings();
      if (!CONFIG.CUSTOMER_KEY) {
        showStatus('âŒ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ç™»éŒ²ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ?key=... ãŒå¿…è¦ï¼‰', true);
        return;
      }
      updateInviteQr();
      document.getElementById('inviteModal').style.display = 'block';
    }
    function closeInvite() { document.getElementById('inviteModal').style.display = 'none'; }

    function updateInviteQr() {
      const qrImg = document.getElementById('inviteQr');
      const keyText = document.getElementById('inviteKeyText');
      keyText.textContent = CONFIG.CUSTOMER_KEY;

      const data = encodeURIComponent(CONFIG.PAGE_URL);
      qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${data}`;
    }

    async function showHistory() {
      closeSettings();
      if (!CONFIG.CUSTOMER_KEY) {
        showStatus('âŒ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ç™»éŒ²ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ?key=... ãŒå¿…è¦ï¼‰', true);
        return;
      }
      document.getElementById('historyModal').style.display = 'block';
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

      try {
        const response = await fetch(`${CONFIG.WORKER_URL}/history`, {
          headers: { 'X-Customer-Key': CONFIG.CUSTOMER_KEY }
        });

        const data = await response.json();

        if (response.ok && data.history && data.history.length > 0) {
          historyList.innerHTML = data.history.map(item => `
            <div class="history-item">
              <div class="history-date">ğŸ“… ${new Date(item.sent_at).toLocaleString('ja-JP')}</div>
              <div class="history-message">${escapeHtml(item.message)}</div>
              <div class="history-stats">
                é€ä¿¡å…ˆ: ${item.target_count}äºº |
                âœ… æˆåŠŸ: ${item.success_count} |
                âŒ å¤±æ•—: ${item.failed_count}
              </div>
            </div>
          `).join('');
        } else {
          historyList.innerHTML = '<p>é€šçŸ¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }
      } catch (error) {
        historyList.innerHTML = `<p class="error">âŒ å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(error.message)}</p>`;
      }
    }
    function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }

    function showBackgroundSettings() { closeSettings(); document.getElementById('backgroundModal').style.display = 'block'; }
    function closeBackgroundSettings() { document.getElementById('backgroundModal').style.display = 'none'; }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageUrl = e.target.result;
          document.body.style.background = 'none';
          document.body.style.backgroundImage = `url('${imageUrl}')`;
          document.body.classList.add('custom-bg');
          localStorage.setItem('customBackground', imageUrl);
          showStatus('âœ… èƒŒæ™¯ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
          closeBackgroundSettings();
        };
        reader.readAsDataURL(file);
      } else {
        showStatus('âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
      }
    }

    function applyCustomBackground() {
      const url = document.getElementById('bgUrlInput').value;
      if (url) {
        document.body.style.background = 'none';
        document.body.style.backgroundImage = `url('${url}')`;
        document.body.classList.add('custom-bg');
        localStorage.setItem('customBackground', url);
        showStatus('âœ… èƒŒæ™¯ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        closeBackgroundSettings();
      } else {
        showStatus('âŒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
      }
    }

    function applyPresetBackground(preset) {
      const presets = {
        1: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        2: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        3: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        4: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        5: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        6: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
      };
      document.body.style.backgroundImage = 'none';
      document.body.style.background = presets[preset];
      document.body.classList.remove('custom-bg');
      localStorage.removeItem('customBackground');
      showStatus('âœ… èƒŒæ™¯ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
      closeBackgroundSettings();
    }

    function resetBackground() {
      document.body.style.backgroundImage = 'none';
      document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      document.body.classList.remove('custom-bg');
      localStorage.removeItem('customBackground');
      showStatus('âœ… èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
      closeBackgroundSettings();
    }

    async function showFamilyManagement() {
      closeSettings();
      if (!CONFIG.CUSTOMER_KEY) {
        showStatus('âŒ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ç™»éŒ²ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ?key=... ãŒå¿…è¦ï¼‰', true);
        return;
      }
      document.getElementById('familyModal').style.display = 'block';
      const familyList = document.getElementById('familyList');
      familyList.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

      try {
        const response = await fetch(`${CONFIG.WORKER_URL}/customer-info`, {
          headers: { 'X-Customer-Key': CONFIG.CUSTOMER_KEY }
        });
        const data = await response.json();

        if (response.ok && data.targets && data.targets.length > 0) {
          familyList.innerHTML = data.targets.map(target => `
            <div class="family-item ${target.is_active ? '' : 'inactive'}">
              <div class="family-nickname">ğŸ‘¤ ${escapeHtml(target.nickname)}</div>
              <div class="family-userid">UserID: ${escapeHtml(target.user_id)}</div>
              <div class="family-date">ç™»éŒ²æ—¥: ${new Date(target.created_at).toLocaleDateString('ja-JP')}</div>
              <div class="family-actions">
                <button class="btn-edit" onclick="editNickname(${target.id}, '${escapeHtml(target.nickname)}')">âœï¸ ç·¨é›†</button>
                <button class="btn-toggle" onclick="toggleActive(${target.id}, ${target.is_active ? 0 : 1})">
                  ${target.is_active ? 'ğŸ”• ç„¡åŠ¹åŒ–' : 'ğŸ”” æœ‰åŠ¹åŒ–'}
                </button>
                <button class="btn-delete" onclick="deleteFamily(${target.id}, '${escapeHtml(target.nickname)}')">ğŸ—‘ï¸ å‰Šé™¤</button>
              </div>
            </div>
          `).join('');
        } else {
          familyList.innerHTML = '<p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å®¶æ—ãŒã„ã¾ã›ã‚“ã€‚</p>';
        }
      } catch (error) {
        familyList.innerHTML = `<p class="error">âŒ å®¶æ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(error.message)}</p>`;
      }
    }
    function closeFamilyManagement() { document.getElementById('familyModal').style.display = 'none'; }

    async function editNickname(id, currentNickname) {
      const newNickname = prompt(`æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, currentNickname);
      if (newNickname && newNickname !== currentNickname) {
        try {
          const response = await fetch(`${CONFIG.WORKER_URL}/update-nickname`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-Customer-Key': CONFIG.CUSTOMER_KEY
            },
            body: JSON.stringify({ id, nickname: newNickname })
          });
          const result = await response.json();
          if (response.ok) {
            showStatus('âœ… ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            showFamilyManagement();
          } else {
            showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${escapeHtml(result.error || 'unknown error')}`, true);
          }
        } catch (error) {
          showStatus(`âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(error.message)}`, true);
        }
      }
    }

    async function toggleActive(id, newStatus) {
      try {
        const response = await fetch(`${CONFIG.WORKER_URL}/toggle-active`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Customer-Key': CONFIG.CUSTOMER_KEY
          },
          body: JSON.stringify({ id, is_active: newStatus })
        });
        const result = await response.json();
        if (response.ok) {
          showStatus(`âœ… é€šçŸ¥ã‚’${newStatus ? 'æœ‰åŠ¹åŒ–' : 'ç„¡åŠ¹åŒ–'}ã—ã¾ã—ãŸ`);
          showFamilyManagement();
        } else {
          showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${escapeHtml(result.error || 'unknown error')}`, true);
        }
      } catch (error) {
        showStatus(`âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(error.message)}`, true);
      }
    }

    async function deleteFamily(id, nickname) {
      if (confirm(`æœ¬å½“ã«ã€Œ${nickname}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        try {
          const response = await fetch(`${CONFIG.WORKER_URL}/delete-target`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-Customer-Key': CONFIG.CUSTOMER_KEY
            },
            body: JSON.stringify({ id })
          });
          const result = await response.json();
          if (response.ok) {
            showStatus('âœ… å®¶æ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            showFamilyManagement();
          } else {
            showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${escapeHtml(result.error || 'unknown error')}`, true);
          }
        } catch (error) {
          showStatus(`âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(error.message)}`, true);
        }
      }
    }

    function escapeHtml(text) {
      const s = String(text ?? '');
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return s.replace(/[&<>"']/g, m => map[m]);
    }

    function showStatus(message, isError = false) {
      const status = document.createElement('div');
      status.className = `status ${isError ? 'error' : ''}`;
      status.textContent = message;
      document.body.appendChild(status);
      setTimeout(() => status.remove(), 3000);
    }

    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      const savedBackground = localStorage.getItem('customBackground');
      if (savedBackground) {
        document.body.style.background = 'none';
        document.body.style.backgroundImage = `url('${savedBackground}')`;
        document.body.classList.add('custom-bg');
      }
      renderKeyBadge();
    });
  </script>
</body>
</html>
