<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ  ã¿ã¾ã‚‚ã‚Šã‚¢ãƒ—ãƒª</title>
  <style>
    body{font-family:system-ui, sans-serif; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); padding:20px;}
    .box{background:rgba(255,255,255,0.95); width:100%; max-width:520px; border-radius:18px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,0.15);}
    h1{margin:0 0 12px; color:#4b5bdc; font-size:26px;}
    .meta{font-size:14px; color:#555; line-height:1.6; margin-bottom:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;}
    input{flex:1; min-width:220px; padding:12px; font-size:16px; border:2px solid #ddd; border-radius:10px;}
    button{width:100%; padding:16px; font-size:20px; border:none; border-radius:999px; color:#fff; cursor:pointer; background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); box-shadow:0 6px 18px rgba(102,126,234,0.35);}
    button:disabled{opacity:0.5; cursor:not-allowed; box-shadow:none;}
    .smallBtn{width:auto; padding:10px 14px; font-size:14px; border-radius:12px;}
    #msg{margin-top:12px; padding:12px; border-radius:12px; font-size:16px; line-height:1.6;}
    .ok{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
    .ng{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
    .note{font-size:12px; color:#666; margin-top:10px; line-height:1.6;}
    .hr{height:1px; background:#eee; margin:14px 0;}
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸ  ã¿ã¾ã‚‚ã‚Šã‚¢ãƒ—ãƒª</h1>

    <div class="meta" id="info">
      èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div class="row">
      <input id="sender" placeholder="é€ä¿¡è€…åï¼ˆä¾‹ï¼šãŠã°ã‚ã¡ã‚ƒã‚“ï¼‰" />
      <button class="smallBtn" onclick="saveSender()">ä¿å­˜</button>
    </div>

    <button id="btn" onclick="send()">ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹</button>

    <div id="msg"></div>

    <div class="hr"></div>

    <div class="note">
      é€£æ‰“é˜²æ­¢ï¼šé€ä¿¡å¾Œã—ã°ã‚‰ãæŠ¼ã›ã¾ã›ã‚“ã€‚<br/>
      é€ä¿¡ã§ããŸã‚‰çŸ­ãæŒ¯å‹•ã—ã¾ã™ï¼ˆç«¯æœ«ã«ã‚ˆã£ã¦æŒ¯å‹•ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
    </div>
  </div>

<script>
  const WORKER_URL = "https://yellow-bird-8e16.kamuibibi4144.workers.dev";
  const DEFAULT_MESSAGE = "ä»Šã€å°‘ã—ä¸å®‰ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚";

  const qs = new URLSearchParams(location.search);
  const customerKey = qs.get("key") || "";
  const senderInput = document.getElementById("sender");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");
  const info = document.getElementById("info");

  // ãƒ•ãƒ­ãƒ³ãƒˆå´ã®é€£æ‰“é˜²æ­¢ï¼ˆç§’ï¼‰
  const FRONT_COOLDOWN = 30;

  function show(text, ok=true){
    msg.className = ok ? "ok" : "ng";
    msg.textContent = text;
  }

  function vibrateOK(){
    try{
      if (navigator.vibrate) navigator.vibrate([80, 40, 80]);
    }catch(e){}
  }

  function loadSender(){
    const saved = localStorage.getItem("mimamori_sender") || "";
    senderInput.value = saved;
  }
  loadSender();

  function saveSender(){
    localStorage.setItem("mimamori_sender", senderInput.value.trim().slice(0,20));
    show("é€ä¿¡è€…åã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", true);
    setTimeout(()=>{ msg.textContent=""; msg.className=""; }, 1200);
  }

  function setButtonCooldown(seconds){
    btn.disabled = true;
    const base = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
    let left = seconds;
    btn.textContent = `${base}ï¼ˆ${left}ç§’ï¼‰`;
    const t = setInterval(()=>{
      left--;
      if(left <= 0){
        clearInterval(t);
        btn.disabled = false;
        btn.textContent = base;
        return;
      }
      btn.textContent = `${base}ï¼ˆ${left}ç§’ï¼‰`;
    }, 1000);
  }

  function getLastLocalSent(){
    const v = localStorage.getItem("mimamori_last_sent") || "";
    return v ? new Date(v) : null;
  }

  function setLastLocalSent(){
    localStorage.setItem("mimamori_last_sent", new Date().toISOString());
  }

  async function refreshInfo(){
    if(!customerKey){
      info.textContent = "URLã® key ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã‹ã‚‰æ¸¡ã•ã‚ŒãŸURLã§é–‹ã„ã¦ãã ã•ã„ã€‚";
      btn.disabled = true;
      return;
    }

    try{
      const r = await fetch(`${WORKER_URL}/customer-info`, {
        headers: { "X-Customer-Key": customerKey }
      });
      const d = await r.json();

      if(!r.ok){
        info.textContent = `ã“ã®URLã¯ä½¿ãˆã¾ã›ã‚“ï¼š${d.error || "error"}`;
        btn.disabled = true;
        return;
      }

      const fam = d.customer.family_name ? d.customer.family_name : "ï¼ˆå®¶æ—åæœªè¨­å®šï¼‰";
      const status = d.customer.status || "active";
      const last = d.customer.last_sent_at ? new Date(d.customer.last_sent_at).toLocaleString("ja-JP") : "ãªã—";
      const sc = d.server?.cooldown_seconds ?? "?";

      if(status !== "active"){
        info.textContent = `å®¶æ—ï¼š${fam}\nçŠ¶æ…‹ï¼šåœæ­¢ä¸­\nã“ã®å®¶æ—ã¯ç¾åœ¨ä½¿ãˆã¾ã›ã‚“ã€‚`;
        btn.disabled = true;
        return;
      }

      info.textContent = `å®¶æ—ï¼š${fam}\næœ€çµ‚é€ä¿¡ï¼š${last}\nã‚µãƒ¼ãƒé€£æ‰“é˜²æ­¢ï¼š${sc}ç§’`;

      // ãƒ­ãƒ¼ã‚«ãƒ«é€£æ‰“é˜²æ­¢ï¼ˆæœ€å¾Œã«æŠ¼ã—ã¦ã™ããªã‚‰æ­¢ã‚ã‚‹ï¼‰
      const lastLocal = getLastLocalSent();
      if(lastLocal){
        const diff = (Date.now() - lastLocal.getTime()) / 1000;
        if(diff < FRONT_COOLDOWN){
          setButtonCooldown(Math.ceil(FRONT_COOLDOWN - diff));
        }
      }
    }catch(e){
      info.textContent = "æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    }
  }

  async function send(){
    if(!customerKey){
      show("URLã® key ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", false);
      return;
    }

    // ãƒ•ãƒ­ãƒ³ãƒˆå´é€£æ‰“é˜²æ­¢
    const lastLocal = getLastLocalSent();
    if(lastLocal){
      const diff = (Date.now() - lastLocal.getTime()) / 1000;
      if(diff < FRONT_COOLDOWN){
        show(`é€£æ‰“é˜²æ­¢ä¸­ã§ã™ã€‚ã‚ã¨ ${Math.ceil(FRONT_COOLDOWN - diff)} ç§’å¾…ã£ã¦ãã ã•ã„ã€‚`, false);
        return;
      }
    }

    btn.disabled = true;
    btn.textContent = "é€ä¿¡ä¸­...";
    msg.className = "";
    msg.textContent = "é€ä¿¡ä¸­...";

    try{
      const senderName = (senderInput.value || "").trim().slice(0,20);

      const r = await fetch(`${WORKER_URL}/notify`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Customer-Key": customerKey
        },
        body: JSON.stringify({
          message: DEFAULT_MESSAGE,
          sender_name: senderName
        })
      });

      const d = await r.json();

      if(r.ok){
        setLastLocalSent();
        vibrateOK();
        show(`é€ä¿¡ã—ã¾ã—ãŸã€‚\næˆåŠŸ:${d.successCount} / å¤±æ•—:${d.failedCount}`, true);

        // ãƒœã‚¿ãƒ³é€£æ‰“é˜²æ­¢ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆï¼‰
        setButtonCooldown(FRONT_COOLDOWN);

        // ç”»é¢ã®æƒ…å ±ã‚‚æ›´æ–°ï¼ˆæœ€çµ‚é€ä¿¡æ™‚åˆ»ã‚’æ›´æ–°ï¼‰
        setTimeout(refreshInfo, 800);
      }else{
        // ã‚µãƒ¼ãƒå´ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãªã©
        const err = d.error || "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
        show(err, false);

        // 429ã®ã¨ãã¯ç§’æ•°ã«åˆã‚ã›ã¦æ­¢ã‚ã‚‹
        if(r.status === 429 && d.cooldown_seconds){
          setButtonCooldown( Math.min(d.cooldown_seconds, 60) );
        }else{
          btn.disabled = false;
          btn.textContent = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
        }
      }
    }catch(e){
      show(`é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e.message}`, false);
      btn.disabled = false;
      btn.textContent = "ğŸ“± å®¶æ—ã«çŸ¥ã‚‰ã›ã‚‹";
    }
  }

  refreshInfo();
</script>
</body>
</html>
